name: Compare

on:
  pull_request:

jobs:
  compare-build-assets:
    name: Compare Build Assets
    runs-on: ubuntu-latest
    steps:
      # Build on PR branch
      - name: Checkout PR branch
        uses: actions/checkout@v3.5.0
      - name: Use Node.js ${{ vars.NODE_VERSION }}
        uses: actions/setup-node@v3.6.0
        with:
          node-version: ${{ vars.NODE_VERSION }}
          cache: npm
      - name: Install PR branch dependencies
        run: npm ci --ignore-scripts
      - name: Build on PR branch
        run: npm run build -- -o current

      # Compare
      - name: Checkout main branch
        uses: actions/checkout@v3.5.0
        with:
          ref: main
          clean: false
      - name: Install main branch dependencies
        run: npm ci --ignore-scripts
      - name: Build on main branch
        run: npm run build
      - name: Setup js-beautify to compare minified js files
        run: |
          npm install --global js-beautify
          git config --local diff.minjs.textconv js-beautify
          echo "index.js diff=minjs" > .gitattributes
      - name: Compare
        id: compare
        continue-on-error: true
        run: |
          echo "# Compare ${{ github.sha }} to main" >> $GITHUB_STEP_SUMMARY
          git diff --no-index --exit-code ./dist/ ./current/ >> $GITHUB_STEP_SUMMARY

      - name: Comment to PR
        if: steps.compare.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            const message = 'There is a difference in the build results.'

            core.warning(message)
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${message} [Show More](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })
